name: Deploy Document Site

on:
    push:
        branches: [dev]
permissions:
    contents: read
    pages: write
    id-token: write
jobs:
    Deploy:
        name: Build and Deploy Documentation
        runs-on: Ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure pnpm
              uses: pnpm/action-setup@v4

            - name: Install doc dependencies
              shell: bash # Corrected from 'shell' to 'bash'
              run: pnpm install --no-frozen-lockfile --filter doc...

            - name: Configure PATH
              shell: pwsh # Use PowerShell Core (cross-platform)
              run: |
                  # 添加必要的路径到系统 PATH
                  $env:PATH = "$env:GITHUB_WORKSPACE/node_modules/.bin:$env:PATH" # Fixed path separator for Unix-based systems
                  $env:PATH = "${{ env.PNPM_STORE_PATH }}:$env:PATH"
                  $env:PATH = "$env:APPDATA/npm:$env:PATH"

                  # 验证路径设置
                  Write-Output "Current PATH: $env:PATH"
                  Get-Command tauri -ErrorAction SilentlyContinue

            - name: Build Documentation
              shell: bash # Corrected from 'shell' to 'bash'
              run: pnpm exec turbo run build --filter=doc

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.PAT_TOKEN }} # 这一步很重要，单独看下面的大步骤，主要是用来给该脚本一些仓库权限
                  publish_dir: ./apps/doc/dist # 指定该文件夹中的 dist
                  publish_branch: gh-pages # 推送到关联仓库的 gh-pages 分支
                  dotfiles: true # 包括在提交中，即使被 .gitignore 文件忽略
