name: Build All Apps in Dev Branch DS version

on:
  push:
    branches: [Dev]
  workflow_dispatch:

env:
  PNPM_VERSION: "8"
  PNPM_STORE_PATH: C:\Users\runneradmin\AppData\Local\pnpm\store\v3
  TAURI_TARGET: "release"

jobs:
  setup:
    name: Setup Environment
    runs-on: windows-latest
    outputs:
      cache-hit: ${{ steps.pnpm-cache.outputs.cache-hit }}
      needs-install: ${{ steps.check-changes.outputs.changed || steps.pnpm-cache.outputs.cache-hit != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Check for changes
        id: check-changes
        shell: pwsh
        run: |
          $changed = git diff --name-only HEAD^ HEAD | Select-String -Pattern "package\.json|pnpm-lock\.yaml"
          echo "::set-output name=changed::$($changed -ne $null)"

      - name: Cache pnpm store
        id: pnpm-cache
        uses: actions/cache@v3
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

  build:
    needs: setup
    name: Build Applications
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Install dependencies
        if: needs.setup.outputs.needs-install == 'true'
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build with Turbo
        run: pnpm turbo run build --output-logs=errors-only
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Build Tauri (Windows)
        if: runner.os == 'Windows'
        run: pnpm tauri build --target ${{ env.TAURI_TARGET }}
        working-directory: ./apps/app
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

  artifacts:
    needs: build
    name: Package Artifacts
    runs-on: windows-latest
    steps:
      - name: Create release archive
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyyMMdd"
          $version = (Get-Content ./apps/app/src-tauri/tauri.conf.json | ConvertFrom-Json).package.version
          Compress-Archive -Path ./apps/doc/dist/* -DestinationPath "./doc-dist-$version-$date.zip"
          Compress-Archive -Path ./apps/app/src-tauri/target/release/bundle/msi/*.msi -DestinationPath "./app-msi-$version-$date.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            ./doc-dist-*.zip
            ./app-msi-*.zip
          retention-days: 7

  deploy:
    needs: artifacts
    name: Deploy to Staging
    if: github.ref == 'refs/heads/Dev'
    runs-on: windows-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages

      - name: Deploy to Azure Blob Storage
        uses: azure/CLI@v1
        with:
          azcliversion: "2.40.0"
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --destination ${{ secrets.AZURE_CONTAINER }} \
              --source ./ \
              --pattern "*.zip" \
              --auth-mode key \
              --account-key ${{ secrets.AZURE_STORAGE_KEY }}